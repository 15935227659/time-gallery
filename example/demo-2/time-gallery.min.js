"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var a=0,i=Array(t.length);a<t.length;a++)i[a]=t[a];return i}return Array.from(t)}function _classCallCheck(t,a){if(!(t instanceof a))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,a){for(var i=0;i<a.length;i++){var e=a[i];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(a,i,e){return i&&t(a.prototype,i),e&&t(a,e),a}}(),TimeGallery=function(){function t(a){_classCallCheck(this,t),""===a.id&&console.error("ID not exist"),this.width=a.width||window.innerWidth,this.height=a.height||window.innerHeight,this._stage=new createjs.Stage(document.getElementById(a.id)),this._stage.canvas.width=this.width,this._stage.canvas.height=this.height,this._loadQueue=null,this._isLoading=!1,this._isEnd=!1,this._dirGroup={horizontal:"horizontal",vertical:"vertical"},this.isVertical=(a.direction||this._dirGroup.vertical)===this._dirGroup.vertical,this.isMoving=!1,this.isState=a.isState||!1,this.isLog=a.isLog||!1,this.autoPlay=a.autoPlay||!1,this.autoSpeed=a.autoSpeed||1,this.resourcesPath=a.resourcesPath||"",this.resources=a.resources||[],this.sprites=a.sprites||{},this.data=a.data||[],this.onInit=a.onInit||null,this.onEnd=a.onEnd||null,this.onTickStart=a.onTickStart||null,this.onTickEnd=a.onTickEnd||null,this.mapStart=a.mapStart||0,this.mapActive=a.mapActive||0,this.mapEnd=a.mapEnd||0,this.mapPlay=a.mapPlay||(this.isVertical?this.height:this.width),this.objects={},this.animatorsGroup=[],this.touchData={touchstart:0,touchmove:0,friction:.9,speed:a.touchSpeed||1,isInertance:!1},this.init()}return _createClass(t,[{key:"init",value:function(){var t=this;this._preload(this.resources,{path:this.resourcesPath,complete:function(){"function"==typeof t.sprites&&(t.sprites=t.sprites(t)),"function"==typeof t.data&&(t.data=t.data(t));var a=[{id:"map",children:t.data}];t._render(a,null,function(a,i){a&&i.animation&&(a.animation=t._createAnimate(a,i.animation),t.animatorsGroup.push({displayObject:a}))}),t.map=t.objects.map;var i=t.mapActive?-t.mapActive:-t.mapStart;if(t.isVertical?t.map.y=i:t.map.x=i,!t.mapEnd){var e=void 0;e=t.isVertical?t.map.getBounds().height+t.map.getBounds().y-t.height:t.map.getBounds().width+t.map.getBounds().x-t.width;var s=Math.max.apply(Math,t.animatorsGroup.map(function(t){return t.displayObject.animation.animatePlayEnd}));t.mapEnd=Math.max(e,s)}t._initTouchEvent(),t.onInit&&t.onInit(),t.isState&&t._stats(),t._stage.update()}}),createjs.Ticker.timingMode=createjs.Ticker.RAF}},{key:"play",value:function(){createjs.Ticker.addEventListener("tick",this._onTick.bind(this))}},{key:"replay",value:function(){this._isEnd=!1,this.touchData.touchstart=0,this.touchData.touchmove=0,this.touchData.isInertance=!1,this.isVertical?this.map.y=-this.mapStart:this.map.x=-this.mapStart,this.animatorsGroup.forEach(function(t){t.displayObject.animation.set(0)}),this._stage.update(),this.play()}},{key:"stop",value:function(){createjs.Ticker.removeAllEventListeners()}},{key:"getImage",value:function(t){return this._loadQueue.getResult(t)}},{key:"_onTick",value:function(){if(!this._isLoading&&this.map&&(this.autoPlay||this.isMoving)){this.onTickStart&&this.onTickStart(this);var t=void 0;if(this.autoPlay?this.isVertical?(this.map.y-=this.autoSpeed,t=-this.map.y):(this.map.x-=this.autoSpeed,t=-this.map.x):this.isMoving&&(this.touchData.isInertance&&(this.touchData.touchmove*=this.touchData.friction,Math.abs(this.touchData.touchmove)<=1&&(this.touchData.touchstart=0,this.touchData.touchmove=0,this.touchData.isInertance=!1,this.isMoving=!1)),this.isVertical?(this.map.y+=this.touchData.touchmove*this.touchData.speed,t=-this.map.y):(this.map.x+=this.touchData.touchmove*this.touchData.speed,t=-this.map.x)),t<this.mapStart&&(this.isVertical?this.map.y=-this.mapStart:this.map.x=-this.mapStart),t>this.mapEnd){if(this._isEnd)return;if(this._isEnd=!0,this.isVertical?this.map.y=-this.mapEnd:this.map.x=-this.mapEnd,this.onEnd)return void this.onEnd()}this.mapActive=this.isVertical?-this.map.y:-this.map.x,this._updateAnimators()}this.isState&&this.stats.update()}},{key:"_updateAnimators",value:function(){var t=this.isVertical?-this.map.y:-this.map.x;this.animatorsGroup.map(function(a){var i=a.displayObject,e=i.animation.animatePlayStart,s=i.animation.animatePlayEnd;if(t>=e&&t<s){var n=Math.abs(t-e);i.animation.update(n)}else t<e?i.animation.update(0):t>s&&i.animation.update(s-e)}),this.onTickEnd&&this.onTickEnd(this),this._stage.update()}},{key:"_initTouchEvent",value:function(){var t=this;this._stage.canvas.addEventListener("touchstart",function(a){t.autoPlay||(t.isVertical?t.touchData.touchstart=a.touches[0].clientY:t.touchData.touchstart=a.touches[0].clientX,t.touchData.isInertance=!1,t.isMoving=!1)}),this._stage.canvas.addEventListener("touchmove",function(a){t.autoPlay||(t.isVertical?(t.touchData.touchmove=a.touches[0].clientY-t.touchData.touchstart,t.touchData.touchstart=a.touches[0].clientY):(t.touchData.touchmove=a.touches[0].clientX-t.touchData.touchstart,t.touchData.touchstart=a.touches[0].clientX),t.isMoving=!0)}),this._stage.canvas.addEventListener("touchend",function(){t.autoPlay||(t.touchData.isInertance=!0)})}},{key:"_preload",value:function(){var t=this,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},e=i.complete,s=void 0===e?function(){}:e,n=i.progress,o=void 0===n?function(){}:n,r=i.error,h=void 0===r?function(){}:r,c=i.path,u=void 0===c?"":c;this.isLoading=!0,this._loadQueue=new createjs.LoadQueue((!0),u),o&&this._loadQueue.on("progress",function(t){return o(t)}),h&&this._loadQueue.on("error",function(t){return h(t)}),this._loadQueue.on("complete",function(a){t.isLoading=!1,s&&s(a)}),this._loadQueue.loadManifest(a)}},{key:"_addObj",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=null;switch(t.type){case"shape":a=new createjs.Shape;break;case"bitmap":t.image&&(a=new createjs.Bitmap(t.image));break;case"text":a=new createjs.Text;break;case"sprite":if(t.sheet){var i=new createjs.SpriteSheet(t.sheet);a=new createjs.Sprite(i)}break;default:a=new createjs.Container}if(t.type?a.type=t.type:a.type="container",t.id&&(a.name=t.id),t.parent_id&&(a.parentId=t.parent_id),t.prop){var e=!0,s=!1,n=void 0;try{for(var o,r=Object.keys(t.prop)[Symbol.iterator]();!(e=(o=r.next()).done);e=!0){var h=o.value;if(a[h]instanceof Object){var c=!0,u=!1,l=void 0;try{for(var d,p=Object.keys(t.prop[h])[Symbol.iterator]();!(c=(d=p.next()).done);c=!0){var m=d.value;if("function"==typeof a[h][m]){var v;(v=a[h])[m].apply(v,_toConsumableArray(t.prop[h][m]))}else a[h][m]=t.prop[h][m]}}catch(y){u=!0,l=y}finally{try{!c&&p["return"]&&p["return"]()}finally{if(u)throw l}}}else if("function"==typeof a[h]){var f;(f=a)[h].apply(f,_toConsumableArray(t.prop[h]))}else a[h]=t.prop[h]}}catch(y){s=!0,n=y}finally{try{!e&&r["return"]&&r["return"]()}finally{if(s)throw n}}if("text"===t.type&&t.prop.align)switch(t.prop.align){case"center":a.x=(this.width-a.getBounds().width)/2;break;case"right":a.x=this.width-a.getBounds().width;break;default:a.x=0}}if(t.method){var g=!0,b=!1,_=void 0;try{for(var k,j=Object.keys(t.method)[Symbol.iterator]();!(g=(k=j.next()).done);g=!0){var w,E=k.value;(w=a)[E].apply(w,_toConsumableArray(t.method[E]))}}catch(y){b=!0,_=y}finally{try{!g&&j["return"]&&j["return"]()}finally{if(b)throw _}}}if(t.event&&t.event.handle){var S=t.event.type||"click";a.addEventListener(S,t.event.handle)}if(a.getBounds()){var x=a.getBounds();a.width=x.width,a.height=x.height}return a}},{key:"_render",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],a=this,i=arguments[1],e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){};t instanceof Object&&(t=Array.from(t)),t.map(function(t){t.parent_id=i,a.objects[t.id]=a._addObj(t),a.isLog&&(console.group(t.id+":"),console.table({x:a.objects[t.id].x,y:a.objects[t.id].y,regX:a.objects[t.id].regX,regY:a.objects[t.id].regY,scaleX:a.objects[t.id].scaleX,scaleY:a.objects[t.id].scaleY,rotation:a.objects[t.id].rotation,alpha:a.objects[t.id].alpha,visible:a.objects[t.id].visible})),i?a.objects[i].addChild(a.objects[t.id]):a._stage.addChild(a.objects[t.id]),e&&e(a.objects[t.id],t),t.children&&a._render(t.children,t.id,e),a.isLog&&console.groupEnd()}),this._stage.update()}},{key:"_createAnimate",value:function(t){function a(a){function i(t){var s=t.parent;s&&null!==s.parent&&(e+=a.isVertical?s.y:s.x,i(s))}var e=0;return i(t),e}function i(a){var i=a/w;if(S.length>1){var e=S.length,s=w/e,n=Math.min(a/s|0,e-1);t.image=S[n]}(X||0===X)&&(t.x=i*(X-V)+V),(Y||0===Y)&&(t.y=i*(Y-M)+M),(b||0===b)&&(t.alpha=i*(b-O)+O),(c||0===c)&&(t.scaleX=i*(c-G)+G),(l||0===l)&&(t.scaleY=i*(l-Q)+Q),(p||0===p)&&(t.skewX=i*(p-z)+z),(v||0===v)&&(t.skewY=i*(v-R)+R),(f||0===f)&&(t.rotation=i*(f-F)+F)}var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=e.x,n=void 0===s?null:s,o=e.y,r=void 0===o?null:o,h=e.scaleX,c=void 0===h?null:h,u=e.scaleY,l=void 0===u?null:u,d=e.skewX,p=void 0===d?null:d,m=e.skewY,v=void 0===m?null:m,y=e.rotation,f=void 0===y?null:y,g=e.alpha,b=void 0===g?1:g,_=e.top,k=void 0===_?0:_,j=e.duration,w=void 0===j?0:j,E=e.sprite,S=void 0===E?[]:E,x=e.startById,D=void 0===x?null:x,P=e.endById,A=void 0===P?null:P,T=e.afterById,I=void 0===T?null:T,B=e.musicById,C=void 0===B?null:B,L=(this.isVertical?t.y:t.x)+a(this),V=t.x,M=t.y,X=n,Y=r,O=t.alpha,G=t.scaleX,Q=t.scaleY,z=t.skewX,R=t.skewY,F=t.rotation,H=!1,W=!1,q=0,J=0;return q=D?this.objects[D].animation.animatePlayStart:I?this.objects[I].animation.animatePlayEnd:L-k>=this.mapPlay?L-k-this.mapPlay:this.mapStart,A&&q<this.objects[A].animation.animatePlayEnd?(J=this.objects[A].animation.animatePlayEnd,w=J-q):J=q+w,{animatePlayStart:q,animatePlayEnd:J,update:function(t){var a=t/w;if(0!==a&&1!==a||W!==!1){if(a>=1?(a=1,W=!1):a<=0?(a=0,W=!1):W=!0,C){var e=document.getElementById(C);e&&(H===!1?(H=!0,e.currentTime=0,e.play()):H===!0&&0===a&&(e.pause(),H=!1),e.loop&&H===!0&&1===a&&(e.pause(),H=!1))}i(t)}},set:function(t){W&&(W=!1),H&&(H=!1),i(t)}}}},{key:"_stats",value:function(){this.stats=new Stats,this.stats.showPanel(0),document.body.appendChild(this.stats.dom)}}]),t}();