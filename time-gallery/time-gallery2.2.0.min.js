"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var i=0,e=Array(t.length);i<t.length;i++)e[i]=t[i];return e}return Array.from(t)}function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,i){for(var e=0;e<i.length;e++){var a=i[e];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(i,e,a){return e&&t(i.prototype,e),a&&t(i,a),i}}(),TimeGallery=function(){function t(i){return _classCallCheck(this,t),i.id?(this._stage=new createjs.Stage(document.getElementById(i.id)),this._loadQueue=null,this._isLoading=!1,this._isEnd=!1,this._isStats=i.isStats||!1,this._isLog=i.isLog||!1,this._isTouch=i.isTouch!==!1,this._dirGroup={horizontal:"horizontal",vertical:"vertical"},this._isVertical=(i.direction||this._dirGroup.vertical)===this._dirGroup.vertical,this._timeline=null,this._delayTime=i.delayTime||0,this._endTime=i.endTime||0,this._activeTime=i.activeTime||0,this._autoPlay=i.autoPlay||!1,this._data=i.data||[],this._objects={},this._animatorsGroup=[],this._loopGroup=[],this._resourcesPath=i.resourcesPath||"",this._resources=i.resources||[],this._sprites=i.sprites||{},this._touchData={touchstart:0,touchmove:0,friction:.92,speed:i.touchSpeed||1,isInertance:!1},this.width=i.width||window.innerWidth,this.height=i.height||(this.width?window.innerHeight/window.innerWidth*this.width:window.innerHeight),this.canvas=this._stage.canvas,this.canvas.width=this.width,this.canvas.height=this.height,this.onInit=i.onInit||null,this.onEnd=i.onEnd||null,this.onTickStart=i.onTickStart||null,this.onTickEnd=i.onTickEnd||null,this.onTimeToStart=i.onTimeToStart||null,this.onTimeToEnd=i.onTimeToEnd||null,this.autoSpeed=i.autoSpeed||1,this.autoUpdate=i.autoUpdate||!1,this.playLine=i.playLine||(this._isVertical?this.height:this.width),this._isTouch&&this._initTouchEvent(),void this._init()):console.error("Canvas id is undefined")}return _createClass(t,[{key:"_init",value:function(){var t=this;this._preload(this._resources,{path:this._resourcesPath,onComplete:function(){"function"==typeof t._sprites&&(t._sprites=t._sprites(t)),"function"==typeof t._data&&(t._data=t._data(t));var i=[{id:"_timeline",children:[{id:"_timedata",children:t._data}]}];if(t._render(i,null,function(i,e){i&&e.animation&&(i.animation=t._createAnimate(i,e.animation),e.animation.loop?(i.loop={speed:e.animation.duration/100*(e.animation.loop.speed||1),reverse:e.animation.loop.reverse||!1,dir:1,rate:0,duration:e.animation.duration},t._loopGroup.push(i)):t._animatorsGroup.push(i))}),t._timeline=t._objects._timeline,t._isVertical?t._objects._timedata.y=t._delayTime:t._objects._timedata.x=t._delayTime,!t._endTime){var e=void 0,a=void 0;e=t._isVertical?t._timeline.getBounds().height+t._timeline.getBounds().y-t.height:t._timeline.getBounds().width+t._timeline.getBounds().x-t.width,a=Math.max.apply(Math,t._animatorsGroup.map(function(t){return t.animation.endPlayTime})),t._endTime=Math.max(e,a)}if(t._activeTime){t._activeTime<0?t._activeTime=0:t._activeTime>t._endTime&&(t._activeTime=t._endTime);var n=-t._activeTime;t._isVertical?t._timeline.y=n:t._timeline.x=n,t._updateAnimators()}t._stage.update(),t._isStats&&t._stats(),t.onInit&&t.onInit(t)}}),createjs.Ticker.timingMode=createjs.Ticker.RAF}},{key:"play",value:function(){var t=this;this._tickEvent&&this.stop(),this._tickEvent=function(){return t._onTick()},createjs.Ticker.addEventListener("tick",this._tickEvent)}},{key:"replay",value:function(){this._isVertical?this._timeline.y=0:this._timeline.x=0,this._animatorsGroup.forEach(function(t){t.animation.set(0)}),this._stage.update(),this.play(),this._initTouchData()}},{key:"stop",value:function(){createjs.Ticker.removeEventListener("tick",this._tickEvent),this._tickEvent=null}},{key:"remove",value:function(t){var i=this._objects[t],e=i.parent;e.removeChild(i),this._removeObject(t),this._stage.update()}},{key:"destroy",value:function(){this.stop(),this._initTouchData(),this._stage.removeAllChildren(),this._stage.update(),this._objects={},this._animatorsGroup=[],this._endTime=0,this._activeTime=0}},{key:"getActiveTime",value:function(){return this._activeTime}},{key:"getEndTime",value:function(){return this._endTime}},{key:"getObject",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(""===t)return this._objects;var i=this._objects[t];if(void 0===i)return null;var e=i.width,a=i.height,n=i.regX,o=i.regY,s=i.rotation,r=i.scaleX,h=i.scaleY,c=i.skewX,l=i.skewY,u=i.alpha,d=i.type,_=i.x,m=i.y,p=i.visible,v={id:t,width:e,height:a,regX:n,regY:o,rotation:s,scaleX:r,scaleY:h,skewX:c,skewY:l,alpha:u,type:d,x:_,y:m,visible:p,target:i};return this._isVertical?v.y=this._getObjectTime(i):v.x=this._getObjectTime(i),v}},{key:"getImage",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return""===t?this._loadQueue:this._loadQueue[t]}},{key:"getSprite",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return""===t?this._sprites:this._sprites[t]}},{key:"timeTo",value:function(t){var i=this,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments[2],n=0;if("string"==typeof t){var o=t[0];switch(o){case"+":case"-":n=this._activeTime+parseInt(t);break;default:return}}else{if("number"!=typeof t)return;n=t}if(this._activeTime!==n)if(this.onTimeToStart&&this.onTimeToStart(this),0===e)this._activeTime=n,this._isVertical?this._timeline.y=-this._activeTime:this._timeline.x=-this._activeTime,this._updateAnimators(),this._stage.update(),this._onTimeToEnd(a);else{this.stop();var s=(new Date).getTime(),r=0,h=1,c=0,l=0,u=0,d=Math.abs(this._activeTime-n);this._activeTime>n&&(h=-1),this._tickEvent=function(){i.onTickStart&&i.onTickStart(i),r=(new Date).getTime(),u=(r-s)/e,l=Math.floor(u*d)*h,l>d&&(l=d),i._activeTime+=l-c,c=l,i._activeTime<0?(i._isVertical?i._activeTime=0:i._activeTime=0,i._onTimeToEnd(a)):i._activeTime>=i._endTime?(i._activeTime=i._endTime,i._onTimeToEnd(a),i._isEnd=!0,i.onEnd&&i.onEnd(i)):u>=1&&i._onTimeToEnd(a),i._isVertical?i._timeline.y=-i._activeTime:i._timeline.x=-i._activeTime,i._updateAnimators(),i.onTickEnd&&i.onTickEnd(i),i._stage.update()},createjs.Ticker.addEventListener("tick",this._tickEvent)}}},{key:"_onTimeToEnd",value:function(t){0!==this._touchData.touchmove&&this._initTouchData(),this.onTimeToEnd&&this.onTimeToEnd(this),t&&t(this),this.play()}},{key:"_onTick",value:function(){if(!this._isLoading&&this._timeline){if(this.onTickStart&&this.onTickStart(this),this._touchData.isMoving||this.autoUpdate||this._autoPlay){var t=this.getActiveTime();this._touchData.isMoving?(this._touchData.isInertance&&(this._touchData.touchmove*=this._touchData.friction,Math.abs(this._touchData.touchmove)<=1&&this._initTouchData()),this._isVertical?(this._timeline.y+=this._touchData.touchmove*this._touchData.speed,t=-this._timeline.y):(this._timeline.x+=this._touchData.touchmove*this._touchData.speed,t=-this._timeline.x)):this._autoPlay&&(this._isVertical?(this._timeline.y-=this.autoSpeed,t=-this._timeline.y):(this._timeline.x-=this.autoSpeed,t=-this._timeline.x)),this._updateTime(t)}this.onTickEnd&&this.onTickEnd(this),(this.autoUpdate||this._touchData.isMoving||this._autoPlay)&&this._stage.update(),this._isStats&&this.stats.update()}}},{key:"_updateTime",value:function(t){if(t<this._endTime&&(this._isEnd=!1),t<0)t=0,this._isVertical?this._timeline.y=0:this._timeline.x=0;else if(t>this._endTime){if(t=this._endTime,this._isVertical?this._timeline.y=-this._endTime:this._timeline.x=-this._endTime,this._isEnd)return;this._isEnd=!0,this.onEnd&&this.onEnd()}this._activeTime=t,this._updateAnimators(),this._updateLoops()}},{key:"_updateAnimators",value:function(){var t=this._isVertical?-this._timeline.y:-this._timeline.x;this._animatorsGroup.map(function(i){var e=i.animation.startPlayTime,a=i.animation.endPlayTime;t>=e&&t<a?i.animation.update(Math.abs(t-e)):t<e?i.animation.set(0):t>=a&&i.animation.set(a-e)})}},{key:"_updateLoops",value:function(){this._loopGroup.map(function(t){var i=t.loop.rate+t.loop.speed*t.loop.dir;t.loop.reverse?i>t.loop.duration?(i=t.loop.duration,t.loop.dir*=-1):i<0&&(i=0,t.loop.dir*=-1):i>t.loop.duration&&(i=0),t.loop.rate=i,t.animation.set(i)})}},{key:"_preload",value:function(){var t=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=e.onComplete,n=void 0===a?function(){}:a,o=e.onProgress,s=void 0===o?function(){}:o,r=e.path,h=void 0===r?"":r;this._isLoading=!0;var c=null;if(Array.isArray(i)){if(0===i.length)return;c=i}else if("string"==typeof i)c=[{src:i,id:i}];else{if("object"!==("undefined"==typeof i?"undefined":_typeof(i)))return!1;i.id||(i.id=i.src),c=[i]}for(var l=0,u=c.length,d={},_=function(i){var e=new Image,a=c[i],o="undefined"==typeof a?"undefined":_typeof(a),r="";"object"===o?r=a.src:"string"===o&&(r=a),e.crossOrigin="*",e.src=h+r,e.onload=function(){a.id?d[a.id]=e:d[r]=e,l++;var i=Math.floor(l/u*100);s(i),i>=100&&(t._isLoading=!1,t._loadQueue=d,n())}},m=0;m<u;m++)_(m)}},{key:"_removeObject",value:function(t){var i=this,e=this._objects[t];e.animation&&this._removeAnimator(e.name);var a=e.children;a.length>0&&a.forEach(function(t){t.children&&i._removeObject(t.name),t.animation&&i._removeAnimator(t.name),delete i._objects[t.name]}),delete this._objects[t]}},{key:"_removeAnimator",value:function(t){for(var i=0,e=this._animatorsGroup.length;i<e;i++)if(this._animatorsGroup[i].name===t)return void this._animatorsGroup.splice(i,1);for(var a=0,n=this._loopGroup.length;a<n;a++)if(this._loopGroup[a].name===t)return void this._loopGroup.splice(a,1)}},{key:"_addObject",value:function(){var t,i,e,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=null;switch(a.type){case"shape":if(n=new createjs.Shape,a.graphics){var o=!0,s=!1,r=void 0;try{for(var h,c=Object.keys(a.graphics)[Symbol.iterator]();!(o=(h=c.next()).done);o=!0){var l=h.value;if(Array.isArray(a.graphics[l])){var u;(u=n.graphics)[l].apply(u,_toConsumableArray(a.graphics[l]))}else a.graphics[l]instanceof Object?n.graphics[l](a.graphics[l]):n.graphics[l](a.graphics[l])}}catch(d){s=!0,r=d}finally{try{!o&&c["return"]&&c["return"]()}finally{if(s)throw r}}}break;case"bitmap":a.image&&(n=new createjs.Bitmap(a.image));break;case"text":n=new createjs.Text;break;case"sprite":if(a.sheet){var _=new createjs.SpriteSheet(a.sheet);n=new createjs.Sprite(_)}break;default:n=new createjs.Container}if(a.type?n.type=a.type:n.type="container",a.id&&(n.name=a.id),a.parent_id&&(n.parentId=a.parent_id),a.prop){var m=!0,p=!1,v=void 0;try{for(var y,f=Object.keys(a.prop)[Symbol.iterator]();!(m=(y=f.next()).done);m=!0){var T=y.value;switch(T){case"index":break;case"mask":var g=new createjs.Shape;switch(a.prop[T].length){case 3:(t=g.graphics).drawCircle.apply(t,_toConsumableArray(a.prop[T]));break;case 4:(i=g.graphics).drawRect.apply(i,_toConsumableArray(a.prop[T]));break;case 5:(e=g.graphics).drawRoundRect.apply(e,_toConsumableArray(a.prop[T]))}n.mask=g;break;default:if(n[T]instanceof Object){var b=!0,k=!1,j=void 0;try{for(var w,E=Object.keys(a.prop[T])[Symbol.iterator]();!(b=(w=E.next()).done);b=!0){var x=w.value;if("function"==typeof n[T][x]){var D;(D=n[T])[x].apply(D,_toConsumableArray(a.prop[T][x]))}else n[T][x]=a.prop[T][x]}}catch(d){k=!0,j=d}finally{try{!b&&E["return"]&&E["return"]()}finally{if(k)throw j}}}else if("function"==typeof n[T]){var S;(S=n)[T].apply(S,_toConsumableArray(a.prop[T]))}else n[T]=a.prop[T]}}}catch(d){p=!0,v=d}finally{try{!m&&f["return"]&&f["return"]()}finally{if(p)throw v}}if("text"===a.type&&a.prop.align)switch(a.prop.align){case"center":n.x=(this.width-n.getBounds().width)/2;break;case"right":n.x=this.width-n.getBounds().width;break;default:n.x=0}}if(a.method){var A=!0,C=!1,I=void 0;try{for(var L,P=Object.keys(a.method)[Symbol.iterator]();!(A=(L=P.next()).done);A=!0){var G,O=L.value;(G=n)[O].apply(G,_toConsumableArray(a.method[O]))}}catch(d){C=!0,I=d}finally{try{!A&&P["return"]&&P["return"]()}finally{if(C)throw I}}}if(a.on)if(a.on instanceof Array&&a.on.length>=2)n.addEventListener(a.on[0],a.on[1]);else if(a.on.handle){var V=a.on.event||"click";n.addEventListener(V,a.on.handle)}if(n.getBounds()){var X=n.getBounds();n.width=X.width,n.height=X.height}return n}},{key:"_render",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],i=this,e=arguments[1],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){};t instanceof Object&&(t=Array.from(t)),t.map(function(t,n){return t.parent_id=e,void 0===t.id&&(t.id=e+"_"+n),i._objects[t.id]?void console.error("Data id:'"+t.id+"' is it exists already"):(i._objects[t.id]=i._addObject(t),i._isLog&&(console.group(t.id+":"),console.table({x:i._objects[t.id].x,y:i._objects[t.id].y,regX:i._objects[t.id].regX,regY:i._objects[t.id].regY,scaleX:i._objects[t.id].scaleX,scaleY:i._objects[t.id].scaleY,rotation:i._objects[t.id].rotation,alpha:i._objects[t.id].alpha,visible:i._objects[t.id].visible})),e?i._objects[e].addChild(i._objects[t.id]):i._stage.addChild(i._objects[t.id]),a&&a(i._objects[t.id],t),t.children&&i._render(t.children,t.id,a),void(i._isLog&&console.groupEnd()))}),t.map(function(t){if(e&&t.prop&&t.prop.index){var a=t.prop.index,n=i._objects[e].numChildren;a>n&&(a=n-1),i._objects[e].setChildIndex(i._objects[t.id],a)}}),this._stage.update()}},{key:"_createAnimate",value:function(t){function i(i){var e=i/k;if(w.length>1){var a=w.length,n=k/a,o=Math.min(i/n|0,a-1);t.image=w[o]}(Y||0===Y)&&(t.x=e*(Y-V)+V),(B||0===B)&&(t.y=e*(B-X)+X),(h||0===h)&&(t.scaleX=e*(h-Q)+Q),(l||0===l)&&(t.scaleY=e*(l-R)+R),(d||0===d)&&(t.skewX=e*(d-U)+U),(m||0===m)&&(t.skewY=e*(m-z)+z),(v||0===v)&&(t.rotation=e*(v-H)+H),(f||0===f)&&(t.alpha=e*(f-M)+M)}var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=e.x,n=void 0===a?null:a,o=e.y,s=void 0===o?null:o,r=e.scaleX,h=void 0===r?null:r,c=e.scaleY,l=void 0===c?null:c,u=e.skewX,d=void 0===u?null:u,_=e.skewY,m=void 0===_?null:_,p=e.rotation,v=void 0===p?null:p,y=e.alpha,f=void 0===y?1:y,T=e.delay,g=void 0===T?0:T,b=e.duration,k=void 0===b?0:b,j=e.sprite,w=void 0===j?[]:j,E=e.startById,x=void 0===E?null:E,D=e.endById,S=void 0===D?null:D,A=e.afterById,C=void 0===A?null:A,I=e.musicById,L=void 0===I?null:I,P=e.musicStopById,G=void 0===P?null:P,O=this._getObjectTime(t)+this._delayTime,V=t.x,X=t.y,Y=n,B=s,M=t.alpha,Q=t.scaleX,R=t.scaleY,U=t.skewX,z=t.skewY,H=t.rotation,W=!1,F=!1,q=null,J=null,K=0,N=0;return K=x?this._objects[x].animation.startPlayTime+g:C?this._objects[C].animation.endPlayTime+g:S?this._objects[S].animation.endPlayTime-k+g:O+g>=this.playLine?O+g-this.playLine:0,N=S?this._objects[S].animation.endPlayTime:K+k,L&&(q=document.getElementById(L)),G&&(J=document.getElementById(G)),{startPlayTime:K,endPlayTime:N,update:function(t){var e=t/k;(0!==e&&1!==e||F!==!1)&&(e>=1?(e=1,F=!1):e<=0?(e=0,F=!1):F=!0,q&&(W===!1?(q.currentTime=0,q.play(),W=!0):W===!0&&0===e&&(q.paused||(q.pause(),W=!1))),J&&(J.paused||J.pause()),i(t))},set:function(t){F&&(F=!1),W&&(W=!1),i(t)}}}},{key:"_getObjectTime",value:function(t){function i(t){var n=t.parent;n&&"_timeline"!==n.name&&(e+=a._isVertical?n.y:n.x,i(n))}var e=this._isVertical?t.y:t.x,a=this;return i(t),e}},{key:"_initTouchEvent",value:function(){var t=this;this.canvas.addEventListener("touchstart",function(i){t._isVertical?t._touchData.touchstart=i.touches[0].clientY:t._touchData.touchstart=i.touches[0].clientX,t._touchData.isInertance=!1,t._touchData.isMoving=!1}),this.canvas.addEventListener("touchmove",function(i){t._isVertical?(t._touchData.touchmove=i.touches[0].clientY-t._touchData.touchstart,t._touchData.touchstart=i.touches[0].clientY):(t._touchData.touchmove=i.touches[0].clientX-t._touchData.touchstart,t._touchData.touchstart=i.touches[0].clientX),t._touchData.isMoving=!0}),this.canvas.addEventListener("touchend",function(){t._touchData.isInertance=!0})}},{key:"_initTouchData",value:function(){this._touchData.touchstart=0,this._touchData.touchmove=0,this._touchData.isInertance=!1,this._touchData.isMoving=!1}},{key:"_stats",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.stats=new Stats,this.stats.showPanel(t),document.body.appendChild(this.stats.dom)}}]),t}();